# çº¿ç¨‹ä¸å¼‚æ­¥ä»»åŠ¡è§„èŒƒ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£å®šä¹‰äº†åç¨‹ä½œç”¨åŸŸç®¡ç†ã€Dispatcher åˆ‡æ¢åŸåˆ™ã€å¼‚æ­¥ä»»åŠ¡å¤„ç†çš„æœ€ä½³å®è·µã€‚

## ğŸ”„ åç¨‹åŸºç¡€

### 1. åç¨‹ä½œç”¨åŸŸ

#### ViewModel ä½œç”¨åŸŸ
```kotlin
class UserViewModel : MviViewModel<UserIntent>() {
    
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨ viewModelScope
    private fun loadUsers() {
        viewModelScope.launch {
            val users = apiService.getUserList()
            _userState.value = UiState.Success(users)
        }
    }
    
    // âŒ é”™è¯¯ï¼šä¸è¦ä½¿ç”¨ GlobalScope
    private fun loadUsers() {
        GlobalScope.launch {  // âŒ ç¦æ­¢
            // ...
        }
    }
}
```

#### Activity/Fragment ä½œç”¨åŸŸ
```kotlin
class UserListActivity : MviActivity<...>() {
    
    override fun observeData() {
        // âœ… æ­£ç¡®ï¼šä½¿ç”¨ lifecycleScope
        lifecycleScope.launch {
            repeatOnLifecycle(Lifecycle.State.STARTED) {
                viewModel.userState.collect { state ->
                    // å¤„ç†çŠ¶æ€
                }
            }
        }
    }
}
```

### 2. Dispatcher åˆ‡æ¢åŸåˆ™

#### é»˜è®¤è§„åˆ™
- **ä¸»çº¿ç¨‹ï¼ˆMainï¼‰**ï¼šUI æ›´æ–°ã€View æ“ä½œ
- **IO çº¿ç¨‹ï¼ˆIOï¼‰**ï¼šç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶æ“ä½œã€æ•°æ®åº“æ“ä½œ
- **Default çº¿ç¨‹**ï¼šCPU å¯†é›†å‹ä»»åŠ¡ï¼ˆè®¡ç®—ã€æ’åºç­‰ï¼‰

#### ä½¿ç”¨è§„èŒƒ
```kotlin
class UserViewModel : MviViewModel<UserIntent>() {
    
    private fun loadUsers() {
        viewModelScope.launch {
            // âœ… æ­£ç¡®ï¼šç½‘ç»œè¯·æ±‚åœ¨ IO çº¿ç¨‹
            val response = withContext(Dispatchers.IO) {
                apiService.getUserList()
            }
            
            // âœ… æ­£ç¡®ï¼šUI æ›´æ–°åœ¨ä¸»çº¿ç¨‹ï¼ˆé»˜è®¤ï¼‰
            _userState.value = UiState.Success(response.data)
        }
    }
    
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨ launchIO å¿«æ·æ–¹æ³•
    private fun loadUsers() {
        launchIO {
            val response = apiService.getUserList()
            launchMain {
                _userState.value = UiState.Success(response.data)
            }
        }
    }
}
```

## ğŸ¯ ç½‘ç»œè¯·æ±‚å¤„ç†

### 1. launchRequest æ‰©å±•å‡½æ•°

#### åŸºç¡€ç”¨æ³•
```kotlin
/**
 * æ‰§è¡Œç½‘ç»œè¯·æ±‚ï¼ˆè‡ªåŠ¨å¤„ç† Loadingã€Successã€Error çŠ¶æ€ï¼‰
 * 
 * @param stateFlow çŠ¶æ€æµï¼Œè‡ªåŠ¨æ›´æ–° UI çŠ¶æ€
 * @param showLoading æ˜¯å¦æ˜¾ç¤º Loadingï¼ˆé»˜è®¤ trueï¼‰
 * @param request ç½‘ç»œè¯·æ±‚ Block
 */
launchRequest(_userState) {
    apiService.getUserList()
}
```

#### å®Œæ•´ç¤ºä¾‹
```kotlin
class UserViewModel : MviViewModel<UserIntent>() {
    
    private val _userState = MutableStateFlow<UiState<List<User>>>(UiState.Idle)
    val userState: StateFlow<UiState<List<User>>> = _userState.asStateFlow()
    
    override fun handleIntent(intent: UserIntent) {
        when (intent) {
            is UserIntent.LoadUsers -> loadUsers()
        }
    }
    
    private fun loadUsers() {
        // âœ… æ­£ç¡®ï¼šä½¿ç”¨ launchRequest è‡ªåŠ¨å¤„ç†
        launchRequest(_userState, showLoading = true) {
            apiService.getUserList()
        }
    }
}
```

#### å¸¦å›è°ƒçš„ç”¨æ³•
```kotlin
/**
 * æ‰§è¡Œç½‘ç»œè¯·æ±‚ï¼ˆå¸¦å›è°ƒï¼‰
 * 
 * @param showLoading æ˜¯å¦æ˜¾ç¤º Loading
 * @param onSuccess æˆåŠŸå›è°ƒ
 * @param onError é”™è¯¯å›è°ƒ
 * @param request ç½‘ç»œè¯·æ±‚ Block
 */
launchRequest(
    showLoading = true,
    onSuccess = { users ->
        // å¤„ç†æˆåŠŸ
        _userState.value = UiState.Success(users)
    },
    onError = { message, throwable ->
        // å¤„ç†é”™è¯¯
        _userState.value = UiState.Error(message, throwable)
    }
) {
    apiService.getUserList()
}
```

### 2. æ‰‹åŠ¨å¤„ç†ç½‘ç»œè¯·æ±‚

#### æ ‡å‡†æ¨¡å¼
```kotlin
private fun loadUsers() {
    viewModelScope.launch {
        try {
            // æ˜¾ç¤º Loading
            _userState.value = UiState.Loading()
            showLoading(true)
            
            // ç½‘ç»œè¯·æ±‚ï¼ˆIO çº¿ç¨‹ï¼‰
            val response = withContext(Dispatchers.IO) {
                apiService.getUserList()
            }
            
            // å¤„ç†å“åº”
            if (response.isSuccess() && response.data != null) {
                _userState.value = UiState.Success(response.data)
            } else {
                _userState.value = UiState.Error(response.message)
                showToast(response.message)
            }
            
        } catch (e: Exception) {
            // ç»Ÿä¸€å¼‚å¸¸å¤„ç†
            val errorData = e.handleException()
            _userState.value = UiState.Error(errorData.message, e)
            showToast(errorData.message)
        } finally {
            // éšè— Loading
            showLoading(false)
        }
    }
}
```

## ğŸ”€ Dispatcher åˆ‡æ¢æŒ‡å—

### 1. ä½•æ—¶åˆ‡æ¢ Dispatcher

#### å¿…é¡»åˆ‡æ¢åˆ° IO
```kotlin
// âœ… ç½‘ç»œè¯·æ±‚
withContext(Dispatchers.IO) {
    apiService.getUserList()
}

// âœ… æ–‡ä»¶æ“ä½œ
withContext(Dispatchers.IO) {
    File(filePath).readText()
}

// âœ… æ•°æ®åº“æ“ä½œ
withContext(Dispatchers.IO) {
    database.userDao().getAll()
}
```

#### å¿…é¡»åˆ‡æ¢åˆ° Main
```kotlin
// âœ… UI æ›´æ–°ï¼ˆé€šå¸¸ä¸éœ€è¦ï¼Œå› ä¸º viewModelScope é»˜è®¤åœ¨ä¸»çº¿ç¨‹ï¼‰
withContext(Dispatchers.Main) {
    _userState.value = UiState.Success(data)
}

// âœ… View æ“ä½œ
withContext(Dispatchers.Main) {
    binding.recyclerView.adapter = adapter
}
```

#### å¯ä»¥åˆ‡æ¢åˆ° Default
```kotlin
// âœ… CPU å¯†é›†å‹ä»»åŠ¡
withContext(Dispatchers.Default) {
    val sortedList = largeList.sorted()
}
```

### 2. å¿«æ·æ–¹æ³•

#### ViewModel æä¾›çš„å¿«æ·æ–¹æ³•
```kotlin
class UserViewModel : MviViewModel<UserIntent>() {
    
    // âœ… ä½¿ç”¨ launchIO
    private fun loadUsers() {
        launchIO {
            val response = apiService.getUserList()
            // è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹æ›´æ–° UI
            _userState.value = UiState.Success(response.data)
        }
    }
    
    // âœ… ä½¿ç”¨ launchMain
    private fun updateUI() {
        launchMain {
            // åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œ
            binding.recyclerView.adapter = adapter
        }
    }
}
```

## ğŸ”„ Flow æ”¶é›†è§„èŒƒ

### 1. ç”Ÿå‘½å‘¨æœŸå®‰å…¨æ”¶é›†

#### ä½¿ç”¨ repeatOnLifecycle
```kotlin
class UserListActivity : MviActivity<...>() {
    
    override fun observeData() {
        lifecycleScope.launch {
            // âœ… æ­£ç¡®ï¼šä½¿ç”¨ repeatOnLifecycle ç¡®ä¿ç”Ÿå‘½å‘¨æœŸå®‰å…¨
            repeatOnLifecycle(Lifecycle.State.STARTED) {
                viewModel.userState.collect { state ->
                    when (state) {
                        is UiState.Success -> showData(state.data)
                        is UiState.Error -> showError(state.message)
                        else -> {}
                    }
                }
            }
        }
    }
}
```

#### ä½¿ç”¨æ‰©å±•å‡½æ•°
```kotlin
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ collectOn æ‰©å±•å‡½æ•°
viewModel.userState.collectOn(
    lifecycleOwner = this,
    state = Lifecycle.State.STARTED
) { state ->
    when (state) {
        is UiState.Success -> showData(state.data)
        else -> {}
    }
}
```

### 2. é¿å…é‡å¤æ”¶é›†

#### ä½¿ç”¨ distinctUntilChanged
```kotlin
// âœ… æ­£ç¡®ï¼šåªåœ¨å€¼å˜åŒ–æ—¶è§¦å‘
viewModel.userState
    .distinctUntilChanged()
    .collectOn(this) { state ->
        // å¤„ç†çŠ¶æ€
    }
```

#### ä½¿ç”¨ collectDistinct æ‰©å±•
```kotlin
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ collectDistinct è‡ªåŠ¨å»é‡
viewModel.userState.collectDistinct(this) { state ->
    // åªåœ¨å€¼å˜åŒ–æ—¶è§¦å‘
}
```

## âš¡ å¹¶å‘å¤„ç†

### 1. å¤šä¸ªå¹¶å‘è¯·æ±‚

#### ä½¿ç”¨ async
```kotlin
private fun loadUserData() {
    viewModelScope.launch {
        // âœ… æ­£ç¡®ï¼šå¹¶å‘æ‰§è¡Œå¤šä¸ªè¯·æ±‚
        val userDeferred = async(Dispatchers.IO) {
            apiService.getUser(userId)
        }
        val postsDeferred = async(Dispatchers.IO) {
            apiService.getUserPosts(userId)
        }
        
        // ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆ
        val user = userDeferred.await()
        val posts = postsDeferred.await()
        
        // æ›´æ–°çŠ¶æ€
        _userState.value = UiState.Success(user)
        _postsState.value = UiState.Success(posts)
    }
}
```

#### ä½¿ç”¨ awaitAll
```kotlin
private fun loadMultipleUsers() {
    viewModelScope.launch {
        // âœ… æ­£ç¡®ï¼šå¹¶å‘æ‰§è¡Œå¤šä¸ªè¯·æ±‚
        val users = listOf("1", "2", "3").map { id ->
            async(Dispatchers.IO) {
                apiService.getUser(id)
            }
        }.awaitAll()
        
        _userState.value = UiState.Success(users)
    }
}
```

### 2. é¡ºåºæ‰§è¡Œ

#### ä½¿ç”¨ await
```kotlin
private fun loadUserAndPosts() {
    viewModelScope.launch {
        // âœ… æ­£ç¡®ï¼šé¡ºåºæ‰§è¡Œ
        val user = withContext(Dispatchers.IO) {
            apiService.getUser(userId)
        }
        val posts = withContext(Dispatchers.IO) {
            apiService.getUserPosts(userId)
        }
        
        _userState.value = UiState.Success(user)
        _postsState.value = UiState.Success(posts)
    }
}
```

## ğŸš« ç¦æ­¢äº‹é¡¹

### 1. ä½œç”¨åŸŸæ»¥ç”¨
```kotlin
// âŒ é”™è¯¯ï¼šä½¿ç”¨ GlobalScope
GlobalScope.launch { ... }

// âŒ é”™è¯¯ï¼šåˆ›å»ºä¸å¿…è¦çš„åç¨‹ä½œç”¨åŸŸ
CoroutineScope(Dispatchers.Main).launch { ... }
```

### 2. Dispatcher é”™è¯¯ä½¿ç”¨
```kotlin
// âŒ é”™è¯¯ï¼šåœ¨ä¸»çº¿ç¨‹æ‰§è¡Œç½‘ç»œè¯·æ±‚
viewModelScope.launch {
    val response = apiService.getUserList()  // âŒ åº”è¯¥åœ¨ IO çº¿ç¨‹
}

// âŒ é”™è¯¯ï¼šåœ¨ IO çº¿ç¨‹æ›´æ–° UI
withContext(Dispatchers.IO) {
    binding.textView.text = "Hello"  // âŒ åº”è¯¥åœ¨ä¸»çº¿ç¨‹
}
```

### 3. ç”Ÿå‘½å‘¨æœŸé—®é¢˜
```kotlin
// âŒ é”™è¯¯ï¼šä¸ä½¿ç”¨ repeatOnLifecycle
lifecycleScope.launch {
    viewModel.userState.collect { ... }  // âŒ é…ç½®æ›´æ”¹æ—¶ä¼šé‡å¤æ”¶é›†
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ repeatOnLifecycle
lifecycleScope.launch {
    repeatOnLifecycle(Lifecycle.State.STARTED) {
        viewModel.userState.collect { ... }
    }
}
```

## ğŸ“ æœ€ä½³å®è·µ

### 1. ç½‘ç»œè¯·æ±‚æ¨¡æ¿
```kotlin
private fun loadData() {
    launchRequest(_dataState) {
        apiService.getData()
    }
}
```

### 2. å¹¶å‘è¯·æ±‚æ¨¡æ¿
```kotlin
private fun loadMultipleData() {
    viewModelScope.launch {
        val data1 = async(Dispatchers.IO) { apiService.getData1() }
        val data2 = async(Dispatchers.IO) { apiService.getData2() }
        
        val result1 = data1.await()
        val result2 = data2.await()
        
        // å¤„ç†ç»“æœ
    }
}
```

### 3. Flow æ”¶é›†æ¨¡æ¿
```kotlin
override fun observeData() {
    lifecycleScope.launch {
        repeatOnLifecycle(Lifecycle.State.STARTED) {
            viewModel.dataState.collect { state ->
                when (state) {
                    is UiState.Success -> showData(state.data)
                    is UiState.Error -> showError(state.message)
                    else -> {}
                }
            }
        }
    }
}
```

---

**æœ€åæ›´æ–°**: 2024-12-17  
**ç»´æŠ¤è€…**: aFramework Team
