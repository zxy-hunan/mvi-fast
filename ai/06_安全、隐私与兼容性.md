# å®‰å…¨ã€éšç§ä¸å…¼å®¹æ€§è§„èŒƒ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£å®šä¹‰äº†å®‰å…¨ç¼–ç è§„èŒƒã€éšç§ä¿æŠ¤è¦æ±‚ã€ç³»ç»Ÿç‰ˆæœ¬å…¼å®¹æ€§å¤„ç†å’Œæƒé™ç®¡ç†çš„æœ€ä½³å®è·µã€‚

## ğŸ”’ å®‰å…¨è§„èŒƒ

### 1. æ•°æ®å­˜å‚¨å®‰å…¨

#### æ•æ„Ÿæ•°æ®å­˜å‚¨
```kotlin
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ MMKV å­˜å‚¨æ•æ„Ÿæ•°æ®ï¼ˆè‡ªåŠ¨åŠ å¯†ï¼‰
val storage = MmkvStorage.getInstance()
storage.putString("token", userToken)
storage.putString("userId", userId)

// âŒ é”™è¯¯ï¼šä½¿ç”¨ SharedPreferences å­˜å‚¨æ•æ„Ÿæ•°æ®
val prefs = getSharedPreferences("user", MODE_PRIVATE)
prefs.edit().putString("token", userToken).apply()  // âŒ ä¸å®‰å…¨
```

#### å¯†ç å¤„ç†
```kotlin
// âœ… æ­£ç¡®ï¼šå¯†ç ä¸å­˜å‚¨ï¼Œåªå­˜å‚¨ Token
// ç™»å½•æˆåŠŸåï¼Œåªä¿å­˜ Tokenï¼Œä¸ä¿å­˜å¯†ç 
storage.putString("token", loginResponse.token)

// âŒ é”™è¯¯ï¼šå­˜å‚¨æ˜æ–‡å¯†ç 
storage.putString("password", password)  // âŒ ç¦æ­¢
```

### 2. ç½‘ç»œå®‰å…¨

#### HTTPS å¼ºåˆ¶
```kotlin
// âœ… æ­£ç¡®ï¼šæ‰€æœ‰ API ä½¿ç”¨ HTTPS
RetrofitClient.init {
    baseUrl = "https://api.example.com"  // âœ… HTTPS
    // ...
}

// âŒ é”™è¯¯ï¼šä½¿ç”¨ HTTP
baseUrl = "http://api.example.com"  // âŒ ç¦æ­¢
```

#### è¯ä¹¦éªŒè¯
```kotlin
// âœ… æ­£ç¡®ï¼šç”Ÿäº§ç¯å¢ƒéªŒè¯è¯ä¹¦
val sslContext = SSLContext.getInstance("TLS")
sslContext.init(null, trustManagers, SecureRandom())

val okHttpClient = OkHttpClient.Builder()
    .sslSocketFactory(sslContext.socketFactory, trustManager)
    .build()
```

#### Token å®‰å…¨
```kotlin
// âœ… æ­£ç¡®ï¼šToken é€šè¿‡ Header ä¼ é€’
@GET("/api/users")
suspend fun getUserList(
    @Header("Authorization") token: String
): ApiResponse<List<User>>

// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ‹¦æˆªå™¨è‡ªåŠ¨æ·»åŠ  Token
class HeaderInterceptor(private val tokenProvider: () -> String) : Interceptor {
    override fun intercept(chain: Interceptor.Chain): Response {
        val request = chain.request().newBuilder()
            .addHeader("Authorization", "Bearer ${tokenProvider()}")
            .build()
        return chain.proceed(request)
    }
}
```

### 3. è¾“å…¥éªŒè¯

#### ç”¨æˆ·è¾“å…¥éªŒè¯
```kotlin
// âœ… æ­£ç¡®ï¼šéªŒè¯ç”¨æˆ·è¾“å…¥
fun validateEmail(email: String): Boolean {
    return android.util.Patterns.EMAIL_ADDRESS.matcher(email).matches()
}

fun validatePassword(password: String): Boolean {
    return password.length >= 8 && 
           password.any { it.isDigit() } &&
           password.any { it.isUpperCase() }
}

// âœ… æ­£ç¡®ï¼šåœ¨ ViewModel ä¸­éªŒè¯
private fun createUser(email: String, password: String) {
    if (!validateEmail(email)) {
        showToast("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
        return
    }
    if (!validatePassword(password)) {
        showToast("å¯†ç è‡³å°‘8ä½ï¼ŒåŒ…å«æ•°å­—å’Œå¤§å†™å­—æ¯")
        return
    }
    // ç»§ç»­å¤„ç†
}
```

#### SQL æ³¨å…¥é˜²æŠ¤
```kotlin
// âœ… æ­£ç¡®ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆå¦‚æœä½¿ç”¨æ•°æ®åº“ï¼‰
@Query("SELECT * FROM users WHERE id = :userId")
suspend fun getUserById(userId: String): User

// âŒ é”™è¯¯ï¼šå­—ç¬¦ä¸²æ‹¼æ¥æŸ¥è¯¢
@Query("SELECT * FROM users WHERE id = '$userId'")  // âŒ ç¦æ­¢
```

### 4. æ—¥å¿—å®‰å…¨

#### æ•æ„Ÿä¿¡æ¯è¿‡æ»¤
```kotlin
// âœ… æ­£ç¡®ï¼šè¿‡æ»¤æ•æ„Ÿä¿¡æ¯
class LoggingInterceptor : Interceptor {
    override fun intercept(chain: Interceptor.Chain): Response {
        val request = chain.request()
        
        // è¿‡æ»¤æ•æ„Ÿ Header
        val headers = request.headers.toMultimap()
            .filterKeys { it != "Authorization" }
        
        Log.d("Network", "Request: ${request.url}")
        Log.d("Network", "Headers: $headers")
        
        return chain.proceed(request)
    }
}

// âŒ é”™è¯¯ï¼šè®°å½•æ•æ„Ÿä¿¡æ¯
Log.d("User", "Token: $token")  // âŒ ç¦æ­¢
Log.d("User", "Password: $password")  // âŒ ç¦æ­¢
```

## ğŸ” éšç§ä¿æŠ¤

### 1. ç”¨æˆ·æ•°æ®ä¿æŠ¤

#### æ•°æ®æœ€å°åŒ–åŸåˆ™
```kotlin
// âœ… æ­£ç¡®ï¼šåªæ”¶é›†å¿…è¦çš„æ•°æ®
data class UserRegistration(
    val email: String,      // âœ… å¿…è¦
    val password: String,   // âœ… å¿…è¦
    // ä¸æ”¶é›†ä¸å¿…è¦çš„ä¸ªäººä¿¡æ¯
)

// âŒ é”™è¯¯ï¼šæ”¶é›†è¿‡å¤šæ•°æ®
data class UserRegistration(
    val email: String,
    val password: String,
    val realName: String,      // âŒ éå¿…è¦
    val idCard: String,         // âŒ éå¿…è¦
    val address: String         // âŒ éå¿…è¦
)
```

#### æ•°æ®åŠ å¯†ä¼ è¾“
```kotlin
// âœ… æ­£ç¡®ï¼šæ•æ„Ÿæ•°æ®åŠ å¯†ä¼ è¾“
@POST("/api/users/register")
suspend fun register(
    @Body request: EncryptedRegistrationRequest  // åŠ å¯†åçš„è¯·æ±‚
): ApiResponse<User>
```

### 2. æƒé™ç”³è¯·

#### è¿è¡Œæ—¶æƒé™
```kotlin
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ XXPermissions ç”³è¯·æƒé™
import com.hjq.permissions.XXPermissions

class MainActivity : MviActivity<...>() {
    
    private fun requestCameraPermission() {
        XXPermissions.with(this)
            .permission(Permission.CAMERA)
            .request { _, allGranted ->
                if (allGranted) {
                    // æƒé™å·²æˆäºˆ
                    openCamera()
                } else {
                    showToast("éœ€è¦ç›¸æœºæƒé™æ‰èƒ½æ‹ç…§")
                }
            }
    }
}
```

#### æƒé™ç”³è¯·æ—¶æœº
```kotlin
// âœ… æ­£ç¡®ï¼šåœ¨éœ€è¦æ—¶ç”³è¯·æƒé™
binding.btnTakePhoto.setOnClickListener {
    if (XXPermissions.isGranted(this, Permission.CAMERA)) {
        openCamera()
    } else {
        requestCameraPermission()
    }
}

// âŒ é”™è¯¯ï¼šåº”ç”¨å¯åŠ¨æ—¶ç”³è¯·æ‰€æœ‰æƒé™
override fun onCreate(savedInstanceState: Bundle?) {
    super.onCreate(savedInstanceState)
    requestAllPermissions()  // âŒ ç¦æ­¢
}
```

### 3. éšç§æ”¿ç­–

#### éšç§æ”¿ç­–å±•ç¤º
```kotlin
// âœ… æ­£ç¡®ï¼šé¦–æ¬¡å¯åŠ¨æ—¶å±•ç¤ºéšç§æ”¿ç­–
class SplashActivity : MviActivity<...>() {
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        
        if (!hasAcceptedPrivacyPolicy()) {
            showPrivacyPolicyDialog {
                acceptPrivacyPolicy()
                navigateToMain()
            }
        } else {
            navigateToMain()
        }
    }
}
```

## ğŸ“± ç³»ç»Ÿå…¼å®¹æ€§

### 1. ç‰ˆæœ¬æ£€æŸ¥

#### API çº§åˆ«æ£€æŸ¥
```kotlin
// âœ… æ­£ç¡®ï¼šæ£€æŸ¥ API çº§åˆ«
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
    // Android 6.0+ çš„åŠŸèƒ½
    requestPermissions()
} else {
    // ä½ç‰ˆæœ¬çš„å¤„ç†
    openCamera()
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ‰©å±•å‡½æ•°ç®€åŒ–
fun Activity.checkPermission(permission: String): Boolean {
    return if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
        checkSelfPermission(permission) == PackageManager.PERMISSION_GRANTED
    } else {
        true
    }
}
```

#### åŠŸèƒ½å¯ç”¨æ€§æ£€æŸ¥
```kotlin
// âœ… æ­£ç¡®ï¼šæ£€æŸ¥åŠŸèƒ½æ˜¯å¦å¯ç”¨
fun checkFeatureAvailability(): Boolean {
    return packageManager.hasSystemFeature(PackageManager.FEATURE_CAMERA)
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ try-catch å¤„ç†å…¼å®¹æ€§
try {
    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
        // Android 8.0+ çš„åŠŸèƒ½
        createNotificationChannel()
    }
} catch (e: Exception) {
    // å…¼å®¹æ€§å¤„ç†
    Log.e("Notification", "Failed to create channel", e)
}
```

### 2. æœ€ä½ç‰ˆæœ¬æ”¯æŒ

#### é¡¹ç›®é…ç½®
```gradle
// build.gradle
android {
    defaultConfig {
        minSdk 23  // Android 6.0
        targetSdk 35  // Android 15
    }
}
```

#### åŠŸèƒ½é™çº§
```kotlin
// âœ… æ­£ç¡®ï¼šä¸ºä½ç‰ˆæœ¬æä¾›é™çº§æ–¹æ¡ˆ
fun showNotification(title: String, message: String) {
    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
        // Android 8.0+ ä½¿ç”¨ NotificationChannel
        showNotificationWithChannel(title, message)
    } else {
        // ä½ç‰ˆæœ¬ä½¿ç”¨ä¼ ç»Ÿæ–¹å¼
        showNotificationLegacy(title, message)
    }
}
```

### 3. å±å¹•é€‚é…

#### å¤šå±å¹•æ”¯æŒ
```xml
<!-- âœ… æ­£ç¡®ï¼šä½¿ç”¨ dp å’Œ sp å•ä½ -->
<TextView
    android:layout_width="100dp"
    android:layout_height="wrap_content"
    android:textSize="14sp" />

<!-- âœ… æ­£ç¡®ï¼šä½¿ç”¨ ConstraintLayout é€‚é…ä¸åŒå±å¹• -->
<androidx.constraintlayout.widget.ConstraintLayout
    android:layout_width="match_parent"
    android:layout_height="match_parent">
    <!-- å¸ƒå±€å†…å®¹ -->
</androidx.constraintlayout.widget.ConstraintLayout>
```

#### æ¨ªç«–å±é€‚é…
```kotlin
// âœ… æ­£ç¡®ï¼šå¤„ç†å±å¹•æ–¹å‘å˜åŒ–
override fun onConfigurationChanged(newConfig: Configuration) {
    super.onConfigurationChanged(newConfig)
    
    if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
        // æ¨ªå±å¸ƒå±€
        binding.recyclerView.layoutManager = GridLayoutManager(this, 2)
    } else {
        // ç«–å±å¸ƒå±€
        binding.recyclerView.layoutManager = LinearLayoutManager(this)
    }
}
```

## ğŸ›¡ï¸ æƒé™ç®¡ç†

### 1. æ–‡ä»¶æƒé™

#### Android 10+ æ–‡ä»¶æƒé™
```kotlin
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ FilePermissionHelper
import com.mvi.core.permission.FilePermissionHelper

class FileActivity : MviActivity<...>() {
    
    private fun selectFile() {
        FilePermissionHelper.requestStoragePermission(this) { granted ->
            if (granted) {
                openFilePicker()
            } else {
                showToast("éœ€è¦å­˜å‚¨æƒé™æ‰èƒ½é€‰æ‹©æ–‡ä»¶")
            }
        }
    }
}
```

#### æ–‡ä»¶è®¿é—®
```kotlin
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ MediaStore è®¿é—®æ–‡ä»¶ï¼ˆAndroid 10+ï¼‰
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {
    val contentUri = MediaStore.Images.Media.EXTERNAL_CONTENT_URI
    // ä½¿ç”¨ ContentResolver è®¿é—®
} else {
    // ä½¿ç”¨ä¼ ç»Ÿæ–‡ä»¶è·¯å¾„
    val file = File(Environment.getExternalStorageDirectory(), "image.jpg")
}
```

### 2. ç½‘ç»œæƒé™

#### ç½‘ç»œçŠ¶æ€æ£€æŸ¥
```kotlin
// âœ… æ­£ç¡®ï¼šæ£€æŸ¥ç½‘ç»œçŠ¶æ€
fun isNetworkAvailable(context: Context): Boolean {
    val connectivityManager = context.getSystemService(Context.CONNECTIVITY_SERVICE) 
        as ConnectivityManager
    
    return if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
        val network = connectivityManager.activeNetwork
        val capabilities = connectivityManager.getNetworkCapabilities(network)
        capabilities?.hasCapability(NetworkCapabilities.NET_CAPABILITY_INTERNET) == true
    } else {
        @Suppress("DEPRECATION")
        connectivityManager.activeNetworkInfo?.isConnected == true
    }
}
```

## ğŸ“ æœ€ä½³å®è·µ

### 1. å®‰å…¨ç¼–ç æ£€æŸ¥æ¸…å•

- [ ] æ‰€æœ‰ API ä½¿ç”¨ HTTPS
- [ ] æ•æ„Ÿæ•°æ®ä½¿ç”¨åŠ å¯†å­˜å‚¨
- [ ] Token é€šè¿‡ Header ä¼ é€’ï¼Œä¸åœ¨ URL ä¸­
- [ ] ç”¨æˆ·è¾“å…¥è¿›è¡ŒéªŒè¯å’Œè¿‡æ»¤
- [ ] æ—¥å¿—ä¸­ä¸åŒ…å«æ•æ„Ÿä¿¡æ¯
- [ ] å¯†ç ä¸å­˜å‚¨ï¼Œåªå­˜å‚¨ Token

### 2. å…¼å®¹æ€§æ£€æŸ¥æ¸…å•

- [ ] æ£€æŸ¥æœ€ä½æ”¯æŒçš„ Android ç‰ˆæœ¬
- [ ] ä½¿ç”¨ç‰ˆæœ¬æ£€æŸ¥ä¿æŠ¤æ–° API è°ƒç”¨
- [ ] ä¸ºä½ç‰ˆæœ¬æä¾›é™çº§æ–¹æ¡ˆ
- [ ] æµ‹è¯•ä¸åŒå±å¹•å°ºå¯¸å’Œæ–¹å‘
- [ ] æµ‹è¯•ä¸åŒ Android ç‰ˆæœ¬

### 3. æƒé™ç”³è¯·æ£€æŸ¥æ¸…å•

- [ ] åªåœ¨éœ€è¦æ—¶ç”³è¯·æƒé™
- [ ] è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦æƒé™
- [ ] å¤„ç†æƒé™è¢«æ‹’ç»çš„æƒ…å†µ
- [ ] æä¾›æƒé™è®¾ç½®çš„å¼•å¯¼

## ğŸš« ç¦æ­¢äº‹é¡¹

### 1. å®‰å…¨è¿è§„
```kotlin
// âŒ é”™è¯¯ï¼šå­˜å‚¨æ˜æ–‡å¯†ç 
storage.putString("password", password)

// âŒ é”™è¯¯ï¼šåœ¨ URL ä¸­ä¼ é€’ Token
@GET("/api/users?token={token}")

// âŒ é”™è¯¯ï¼šè®°å½•æ•æ„Ÿä¿¡æ¯
Log.d("User", "Token: $token")
```

### 2. å…¼å®¹æ€§è¿è§„
```kotlin
// âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨æ–° API ä¸æ£€æŸ¥ç‰ˆæœ¬
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
    createNotificationChannel()  // âŒ ç¼ºå°‘ try-catch
}

// âŒ é”™è¯¯ï¼šç¡¬ç¼–ç  API çº§åˆ«
if (Build.VERSION.SDK_INT >= 26) {  // âŒ åº”è¯¥ä½¿ç”¨å¸¸é‡
}
```

---

**æœ€åæ›´æ–°**: 2024-12-17  
**ç»´æŠ¤è€…**: aFramework Team
